<!DOCTYPE html><html lang="udm" dir="ltr" prefix="og: https://ogp.me/ns# article: https://ogp.me/article# scm: https://schema.org/"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>XKB Configuration Hell</title><meta name="description" content="X Keyboard provides vast possibilities to customize your typing, but you&amp;#39;ll first need to find a way to them."><meta property="og:type" content="article"><meta property="og:locale" content="udm_RU"><meta property="og:site_name" content="Коӵышгу"><meta property="og:image" content="https://kotwys.github.io/articles/xkb-configuration/cover.jpg"><meta property="og:title" content="XKB Configuration Hell"><meta property="og:url" content="https://kotwys.github.io/articles/xkb-configuration/en.html"><meta property="og:description" content="X Keyboard provides vast possibilities to customize your typing, but you&amp;#39;ll first need to find a way to them."><meta property="og:image:alt" content="A keyboard, three keys in the center say “XKB”"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:creator" content="@kotwys"><meta property="telegram:channel" content="@ktwsgu"><meta property="article:author" content="Коӵыш Микайло"><meta property="article:published_time" content="2021-07-12T00:00:00.000Z"><link rel="alternate" href="/feed.xml" type="application/atom+xml" title="Коӵышгу — Гожъямъёс"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/styles/light.css"><link rel="stylesheet" href="/styles/dark.css" media="(prefers-color-scheme: dark)"><link rel="stylesheet" href="/styles/main.css"><link rel="stylesheet" href="/styles/article.css"><link rel="me" href="https://twitter.com/kotwys"><link rel="me" href="https://mastodon.social/@kotwys"><link rel="me" href="https://github.com/kotwys"><link rel="webmention" href="https://webmention.io/kotwys.github.io/webmention"><link rel="pingback" href="https://webmention.io/kotwys.github.io/xmlrpc"><link rel="canonical" href="https://kotwys.github.io/articles/xkb-configuration/en.html"><meta name="theme-color" content="#3b2425"></head><body><header class="header theme-hero main-pad"><a class="header__logo" href="/" aria-label="Дорбаме"><img src="/assets/logo.svg" width="24"></a><div class="header-drawer"><button class="header-drawer__button init" title="Менюез усьтоно" aria-controls="header-drawer" aria-expanded="false"><svg class="icon"><use id="header-drawer-icon" href="/assets/icons/sprite.svg#menu-2-line"/></svg></button><div class="header-drawer__content" id="header-drawer"><nav class="nav"><ul><li><a class="hollow-link" href="/articles">Гожъямъёс</a></li><li><a class="hollow-link">Кыллюкам</a></li></ul></nav></div></div><div class="header__progress"></div></header><main><article about="https://kotwys.github.io/articles/xkb-configuration/en.html" typeof="scm:Article"><header class="article-hero hero theme-hero article-hero_has-image prose"><div class="main-margin"><h1 class="article-hero__heading" property="scm:headline scm:name">XKB Configuration Hell</h1><p property="scm:abstract">X Keyboard provides vast possibilities to customize your typing, but you'll first need to find a way to them.</p><p class="article-hero__meta"><time property="scm:datePublished" datetime="2021-07-12T00:00:00.000Z">12. пст 2021 </time><span rel="scm:creator scm:author"><span resource="https://kotwys.github.io#me" typeof="scm:Person"><span property="scm:familyName">Коӵыш</span> <span property="scm:givenName">Микайло</span> </span></span><span>4 минут лыдӟон</span></p></div><figure class="article-hero__image"><img rel="scm:thumbnailUrl scm:image" src="cover.jpg" alt="A keyboard, three keys in the center say “XKB”"></figure></header><div id="toc" class="main-margin toc"><nav class="main-margin toc__nav" id="toc-content"><div class="position: relative;"><h2 class="toc__heading">Пуштросэз</h2><button aria-controls="toc-toplevel" class="toc__expand" aria-expanded="true" title="Пуштросэз ватоно"><svg class="icon"><use href="/assets/icons/sprite.svg#arrow-down-s-line"/></svg></button></div><ul class="toc__list" id="toc-toplevel"><li class="toc__item"><a class="toc__link" href="#the-problem">The problem</a></li><li class="toc__item"><a class="toc__link" href="#configuration">Configuration</a></li><li class="toc__item"><a class="toc__link" href="#rules">Rules</a></li></ul></nav></div><div class="article__content prose prose-wide" data-track><aside><p>TL;DR: If you're using NixOS, ready module is available in my <a href="https://github.com/kotwys/lymypyry/blob/main/modules/extra-xkb-options.nix">flake</a>.</p></aside><p>XKB (X Keyboard) is the part of Linux graphical environment responsible for comfortable usage of keyboard. Thanks to it we have, for example, different languages and layouts.</p><p>It's clear from its name that XKB appeared when XFree86 was emerging. But even now, as Wayland is coming to us, XKB remains a part of our systems. Meanwhile the documentation doesn't seem to have gone far since then.</p><h2 id="the-problem" tabindex="-1">The problem</h2><figure><img src="https://ilyabirman.ru/projects/typography-layout/i/layout-win@2x.png" alt=""><figcaption>Ilya Birman's typographic layout</figcaption></figure><p>I'm using <a href="https://ilyabirman.ru/projects/typography-layout/">Ilya Birman's typographic layout</a> for a while now (no ads.) It's quite easy to type in different symbols with diacritics with it. But it seems missing on Linux… or is it?</p><p>For some time there is <code>misc:typo</code> option in XKB which is said to be based on the typographic layout. However there are no dead keys (the exact keys allowing to type in diacritics.) I don't know the reason for it—perhaps, not to plagiarize the work of Ilya Birman (we're in free software after all!), or because it wasn't international enough. Whatever the why is, I needed to do something with it.</p><p>There is a <a href="https://github.com/neochief/birman-typography-layouts-for-ubuntu">layout prepared for Ubuntu</a> on the Internet. It isn't flawless either as it lacks a couple of symbols. Furthermore, when XKB is updated once in a blue moon, it's needed to reapply the modifications anew. So I decided to dive in myself.</p><h2 id="configuration" tabindex="-1">Configuration</h2><p>Layouts and options are all symbol sets. In addition to it XKB cares about key presses and interpreting the codes coming from keyboard but we're not interested in that.</p><p>Layouts are covering most of the keys, and options are covering only a partion being some kind of a mixin to the former. More than that, as they are a single entity, you can include one inside the other.</p><pre><code>/usr/share/X11/xkb/symbols/us

// This is a layout.
// The first three keywords are not interesting to us, they simply mean that 
// the layout covers only a part of the alphanumeric keys.
partial alphanumeric_keys default
xkb_symbols &quot;basic&quot; {
  keys &lt;AD01&gt; { [ q, Q ] };
  keys &lt;AD02&gt; { [ w, W ] };
  // and so on
};

/usr/share/X11/xkb/symbols/typo

// This is an option.
partial alphanumeric_keys
xkb_symbols &quot;deadkeys&quot; {
  // Symbol sets are at most composed from four levels which are activated as 
  // follows:
  //                 1.        2.        3.         4.
  //                         Shift     AltGr    Shift+AltGr
  keys &lt;AD01&gt; { [ NoSymbol, NoSymbol, NoSymbol, dead_breve ] };
  keys &lt;AD04&gt; { [ NoSymbol, NoSymbol, NoSymbol, dead_abovering ] };
  // and so on
};

// And here everything is put all together
partial alphanumeric_keys
xkb_symbols &quot;layout_extra&quot; {
  include &quot;us(basic)+deadkeys+level3(ralt_switch)&quot;
};
</code></pre><p>The above adds <code>layout_extra</code> layout. Pressing simultaneously AltGr (the right Alt) and big Q should give us breve symbol which would compose on top of any symbol entered next (as in letter Й.) <code>layout_extra</code> explicitly includes <code>level3(ralt_switch)</code> option so that AltGr is the key to move to the third level, there are other option (differing from Windows IIRC.)</p><p>This part isn't any hard, the question is only to sit a while writing the symbols (and don't forget the semicolon after the <code>xkb_symbols</code> definition.) The hard part is to make it visible to the system.</p><p>Everything in XKB makes its way to the big list of rules. Usually it is <code>rules/evdev</code> (there are other.) In that file it's written when, how and where is one or the other symbol list activated.</p><p>You can look for the layouts in the aforementioned [layout for Ubuntu][layout]. I'll explain the options here.</p><h2 id="rules" tabindex="-1">Rules</h2><p>Every options appears at least in one section:</p><pre><code>/usr/share/X11/xkb/rules/evdev

! option = symbols
  grp:shift_toggle = +group(shifts_toggle)
  grp:switch = +group(grp_switch)
  // etc.
</code></pre><p>Here, symbol list from the second column becomes visible by the name in the first column. And now it's available through <code>setxkbmap</code> or other user interface.</p><pre><code>$ setxkbmap -option grp:shift_toggle
</code></pre><p>By the way, these options (<code>grp:*</code>) define the way to switch groups. All the different layouts are in fact symbol groups laid one on top of the other, even if it isn't said so to the user. These symbols groups form one big layout.</p><figure><img width="900" src="groups.jpg" alt="Underneath is English group +en:1, atop is Russian +ru:2"><figcaption>English and Russian groups</figcaption></figure><p>The typographic layout was meant to apply on top of English and Russian layouts. But not so fast.</p><p>As Russian and English are different symbol groups, it's needed to apply the option to each one separately. Otherwise it would be usable only in the English layout (if it's the first one.)</p><p>Digging through the rule file, I found out that <code>misc:typo</code> and one another option are special. They're implicitly applied to every symbol group. And it's written as follows:</p><pre><code>! layout    option    = symbols
  *         misc:typo   +typo(base)

! layout[1] option    = symbols
  *         misc:typo   +typo(base):1

! layout[2] option    = symbols
  *         misc:typo   +typo(base):2

// and this way to four
</code></pre><p>In other words, for each symbol group in case of <code>misc:typo</code> enabled the symbol set in question is applied shifted to the specified amount (<code>+...:n</code>.)</p><p>So, to make the newly created dead keys available you need to add these lines (changing the name and <code>n</code> accordingly.)</p><pre><code>  en &lt;name&gt; = +typo(deadkeys):n
  ru &lt;name&gt; = +typo(deadkeys):n
</code></pre></div></article></main><footer class="footer theme-hero main-pad"><section class="prose"><p style="font-style: italic;">Коӵыш Микайло</p><p>Солэсь но троссэ <a href="https://t.me/ktwsgu">«Коӵышгу» тэлеграм каналысьтым</a> лыдӟе!</p><p>Вотэсбамез люкам нунал: 30. пст 2023</p></section><section><h2 class="visually-hidden">Вотэсбамтӥ навигация</h2><nav class="nav"><ul><li><a class="hollow-link" href="/articles">Гожъямъёс</a></li><li><a class="hollow-link">Кыллюкам</a></li></ul></nav></section><section><h2 class="visually-hidden">Монэн герӟаськон</h2><ul class="socials"><li><a class="social-link" href="https://t.me/kotwys"><span class="icon" title="Telegram"><svg class="icon"><use href="/assets/icons/sprite.svg#send-plane-2-line"/></svg> </span><span>@kotwys</span></a></li><li><a class="social-link" href="https://twitter.com/kotwys"><span class="icon" title="Twitter"><svg class="icon"><use href="/assets/icons/sprite.svg#twitter-line"/></svg> </span><span>@kotwys</span></a></li><li><a class="social-link" href="https://github.com/kotwys"><span class="icon" title="GitHub"><svg class="icon"><use href="/assets/icons/sprite.svg#github-line"/></svg> </span><span>@kotwys</span></a></li><li><a class="social-link" href="https://mastodon.social/@kotwys"><span class="icon" title="Mastodon"><svg class="icon"><use href="/assets/icons/sprite.svg#mastodon-line"/></svg></span></a></li></ul></section></footer><script type="module" src="/scripts/index.js"></script><script type="module" src="/scripts/toc.js"></script></body></html>